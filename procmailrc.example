# Kayako multi-queue forwarder
# =============================================================================
# Installation:
#   1. Copy this file to /etc/procmail/kayako.rc (or any path you prefer)
#   2. Edit the address list in the second recipe (comma-separated, no spaces)
#   3. Ensure /usr/local/bin/kayako_duplicator.py is installed and executable
#   4. Add an alias in /etc/aliases to pipe inbound mail here:
#
#        kayako-inbound: "|/usr/bin/procmail -m /etc/procmail/kayako.rc"
#
#   5. Run: newaliases
#
# Postfix does NOT need procmail as its global LDA. The alias pipes only the
# target address through procmail with this specific config file (-m flag).
# All other mail is delivered normally.
#
# How it works:
#   - The first recipe silently drops any mail that has already been processed,
#     identified by the X-Kayako-Dup: 1 header the script adds to each copy.
#   - The second recipe pipes all other inbound mail through the duplicator
#     script, which sends a uniquely modified copy to each Kayako queue.
#
# Anti-loop guarantee:
#   Re-injected copies carry X-Kayako-Dup: 1, so the first recipe catches
#   them before the second recipe fires. Procmail exits immediately, and the
#   copies are delivered normally by Postfix without re-entering this recipe.
# =============================================================================

# --- Anti-loop guard: skip already-processed duplicates ---
:0
* ^X-Kayako-Dup: 1
/dev/null

# --- Forward a modified copy to each Kayako queue ---
# Edit the address list below. Use commas with no spaces between addresses.
:0
| /usr/local/bin/kayako_duplicator.py support@kayako.com,billing@kayako.com
